<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Venda Rápida - Boss Express</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
    <style>
        /* === THEME BOSS EXPRESS === */
        :root {
            --boss-yellow: #FFC107;
            --boss-yellow-dark: #E0A800;
            --boss-yellow-light: #FFF3CD;
            --boss-text-dark: #333333;
            --boss-text-on-yellow: #333333;
            --boss-text-light: #FFFFFF;
            --boss-background-main: #f8f9fa;
            --boss-background-content: #ffffff;
            --boss-border-color: #dee2e6;
            --boss-border-color-strong: #c0c0c0;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --info-color: #007bff;
            --pending-color: #ffc107; /* Amarelo para pendente/fiado */
            --text-muted: #6c757d;
            --shadow-sm: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
            --shadow-md: 0 0.3rem 0.75rem rgba(0,0,0,0.1);
            --border-radius: 0.375rem; /* 6px */
            --font-family: Arial, sans-serif;
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: var(--font-family);
            background-color: var(--boss-background-main);
            color: var(--boss-text-dark);
            line-height: 1.6;
            font-size: 15px;
            -webkit-tap-highlight-color: transparent;
            display: flex;
            justify-content: center;
            padding-top: 10px;
        }

        .app-container {
            width: 100%;
            max-width: 480px;
            height: calc(100vh - 20px);
            max-height: 800px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            background-color: var(--boss-background-content);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            overflow: hidden;
        }

        .top-header {
            background-color: var(--boss-yellow);
            color: var(--boss-text-on-yellow);
            padding: 10px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--boss-yellow-dark);
            flex-shrink: 0;
        }
        .top-header h1 {
            font-size: 1.15em;
            margin: 0;
            font-weight: 600;
        }
        .top-header h1 i { margin-right: 8px; }
        .top-header .header-buttons-group {
            display: flex;
            gap: 8px;
        }
        .top-header .header-action-btn {
            background-color: var(--boss-yellow-dark);
            color: var(--boss-text-light);
            border: none;
            padding: 6px 10px;
            font-size: 0.8em;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
        }
        .top-header .header-action-btn:hover { background-color: #D18C00; }
        .top-header .header-action-btn i { margin-right: 5px; }


        .venda-content-area {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            overflow: hidden;
        }

        #product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            gap: 10px;
            padding: 15px;
            overflow-y: auto;
            flex-grow: 1;
            background-color: var(--boss-background-main);
        }
        .product-card {
            background-color: var(--boss-background-content);
            border: 1px solid var(--boss-border-color);
            border-radius: var(--border-radius);
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.1s ease, box-shadow 0.15s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            box-shadow: var(--shadow-sm);
        }
        .product-card:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); }
        .product-card.out-of-stock-bolsa { background-color: #f0f0f0; cursor: not-allowed; opacity: 0.7; }
        .product-card.out-of-stock-bolsa .product-stock-bolsa { color: var(--danger-color); font-weight: 600; }
        .product-card:not(.out-of-stock-bolsa):active { transform: scale(0.96); }

        .product-card .product-name {
            font-weight: 600; font-size: 0.875em; margin-bottom: 5px;
            word-break: break-word; min-height: 34px;
            color: var(--boss-text-dark);
            line-height: 1.3;
        }
        .product-card .product-price {
            font-size: 0.95em; color: var(--success-color);
            font-weight: 700; margin-bottom: 5px;
        }
        .product-card .product-stock-bolsa {
            font-size: 0.75em; color: var(--text-muted);
            margin-top: auto; padding-top: 4px;
        }

        #cart-and-checkout-area {
            background-color: var(--boss-background-content);
            padding: 15px;
            border-top: 1px solid var(--boss-border-color-strong);
            box-shadow: 0 -2px 8px rgba(0,0,0,0.06);
            flex-shrink: 0;
        }
        #cart-items-list {
            list-style: none; padding: 0; margin: 0 0 12px 0;
            max-height: 100px;
            overflow-y: auto;
            border: 1px solid var(--boss-border-color);
            border-radius: var(--border-radius);
            padding: 8px;
        }
        #cart-items-list li {
            display: flex; justify-content: space-between; align-items: center;
            padding: 6px 0; font-size: 0.875em;
            border-bottom: 1px dotted var(--boss-border-color);
        }
        #cart-items-list li:last-child { border-bottom: none; }
        .cart-item-details { flex-grow: 1; margin-right: 8px;}
        .cart-item-name { font-weight: 500; }
        .cart-item-price { color: var(--text-muted); font-size: 0.9em; display: block; }
        .cart-item-controls { display: flex; align-items: center; gap: 6px; }
        .cart-item-controls button {
            background-color: var(--text-muted); color: white; border: none;
            width: 24px; height: 24px; border-radius: 50%;
            font-size: 0.8em; cursor: pointer; display: flex;
            align-items: center; justify-content: center; transition: background-color 0.2s;
        }
        .cart-item-controls button:hover { background-color: var(--boss-text-dark); }
        .cart-item-controls button.remove-item-btn { background-color: var(--danger-color); }
        .cart-item-controls button.remove-item-btn:hover { background-color: #c82333; }
        .cart-item-controls button:disabled { background-color: #ccc; cursor: not-allowed; }
        .cart-item-quantity { font-weight: 600; min-width: 18px; text-align: center; }

        #cart-total-display {
            text-align: right; font-size: 1.2em; font-weight: 700;
            color: var(--boss-text-dark); margin-bottom: 12px;
        }

        #payment-options-selector { margin-bottom: 12px; }
        #payment-options-selector h3 {
            font-size: 0.95em; color: var(--boss-text-dark);
            margin-bottom: 8px; text-align: left; font-weight: 600;
        }
        .payment-methods-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
            gap: 8px;
        }
        .payment-method-btn {
            background-color: var(--boss-background-content);
            color: var(--boss-text-dark);
            border: 1px solid var(--boss-border-color-strong);
            padding: 10px 8px; font-size: 0.75em;
            border-radius: var(--border-radius); cursor: pointer;
            text-align: center; transition: all 0.2s ease; font-weight: 500;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            line-height: 1.2; min-height: 50px;
        }
        .payment-method-btn i { font-size: 1.2em; margin-bottom: 4px; }
        .payment-method-btn.selected, .payment-method-btn:hover {
            border-color: var(--boss-yellow-dark);
            background-color: var(--boss-yellow-light);
            color: var(--boss-text-on-yellow);
            font-weight: 600;
        }
        .payment-method-btn.selected { box-shadow: 0 0 0 2px var(--boss-yellow); }
        .payment-method-btn.pagar-depois { border-color: var(--pending-color); }
        .payment-method-btn.pagar-depois.selected, .payment-method-btn.pagar-depois:hover {
            border-color: var(--pending-color); background-color: var(--boss-yellow-light); color: var(--boss-text-on-yellow);
            box-shadow: 0 0 0 2px var(--pending-color);
        }

        #cash-payment-details {
            margin-top: 10px; padding: 10px;
            border: 1px solid var(--boss-border-color);
            border-radius: var(--border-radius);
            background-color: var(--boss-yellow-light);
        }
        #cash-payment-details label { display: block; margin-bottom: 5px; font-size: 0.9em; font-weight: 500;}
        #cash-payment-details input[type="number"] {
            width: 100%; padding: 8px; font-size: 1em;
            border: 1px solid var(--boss-border-color-strong);
            border-radius: var(--border-radius); margin-bottom: 8px;
        }
        #change-due-display { font-weight: bold; font-size: 1em; color: var(--success-color); }
        #change-due-display.negative { color: var(--danger-color); }


        #finalize-sale-btn-container { margin-top: 10px; }
        #finalize-sale-btn {
            background-color: var(--success-color);
            color: white; width: 100%; padding: 12px;
            font-size: 1.05em; border: none;
            border-radius: var(--border-radius); cursor: pointer;
            text-transform: uppercase; font-weight: 700;
            transition: background-color 0.2s ease;
        }
        #finalize-sale-btn:hover { background-color: #218838; }
        #finalize-sale-btn:disabled { background-color: #adb5bd; color: #6c757d; cursor: not-allowed; }
        #finalize-sale-btn i { margin-right: 8px; }

        .modal {
            display: none; position: fixed; z-index: 1000;
            left: 0; top: 0; width: 100%; height: 100%;
            overflow-y: auto; background-color: rgba(0,0,0,0.55);
            align-items: center; justify-content: center;
            padding: 15px;
        }
        .modal-content-wrapper {
            background-color: var(--boss-background-content);
            padding: 20px 25px;
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 500px;
            box-shadow: var(--shadow-md);
            position: relative;
            animation: fadeInModal 0.3s ease-out;
            display: flex; flex-direction: column;
        }
        @keyframes fadeInModal { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }

        .modal-header-area {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; padding-bottom: 12px;
            border-bottom: 1px solid var(--boss-border-color);
            flex-shrink: 0;
        }
        .modal-header-area h2 {
            font-size: 1.3em; margin: 0; color: var(--boss-text-dark); font-weight: 600;
        }
        .modal-header-area h2 i { margin-right: 10px; color: var(--boss-yellow-dark); }
        .modal-close-button {
            font-size: 1.6em; color: var(--text-muted); background: none;
            border: none; cursor: pointer; padding: 0 5px; line-height: 1;
        }
        .modal-close-button:hover { color: var(--boss-text-dark); }
        .modal-body-content {
            overflow-y: auto;
            flex-grow: 1;
            padding-right: 5px;
        }
        .modal-footer-area {
             margin-top: 15px;
             padding-top: 15px;
             border-top: 1px solid var(--boss-border-color);
             flex-shrink: 0;
        }
        .modal-footer-area button { width: 100%; padding: 12px; font-size: 1em; }


        #montar-bolsa-modal .modal-content-wrapper {
            max-width: 550px; max-height: 90vh;
        }
        #montar-bolsa-modal .modal-description-text {
            font-size:0.9em; color:var(--text-muted); margin-bottom:15px;
            flex-shrink: 0;
        }
        #lista-catalogo-para-bolsa {
            flex-grow: 1; overflow-y: auto; margin-bottom: 15px;
            border: 1px solid var(--boss-border-color);
            border-radius: var(--border-radius); padding: 8px; min-height: 150px;
            display: flex; flex-direction: column;
            align-items: stretch; justify-content: flex-start;
        }
        .catalogo-bolsa-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 5px; border-bottom: 1px solid #eee; flex-shrink: 0;
        }
        .catalogo-bolsa-item:last-child { border-bottom: none; }
        .catalogo-bolsa-item label {
            flex-grow: 1; font-size: 0.9em; margin-right: 10px;
            display: flex; flex-direction: column;
        }
        .catalogo-bolsa-item label .item-name { font-weight: 500; }
        .catalogo-bolsa-item label .item-stock-info { font-size: 0.8em; color: var(--text-muted); }
        .catalogo-bolsa-item input[type="number"] {
            width: 70px; padding: 8px; text-align: center;
            border: 1px solid var(--boss-border-color-strong);
            border-radius: var(--border-radius); font-size: 0.9em; flex-shrink: 0;
        }
        .catalogo-bolsa-item input[type="number"]:focus {
            border-color: var(--boss-yellow); outline: none;
            box-shadow: 0 0 0 2px var(--boss-yellow-light);
        }


        #pix-qrcode-modal .modal-content-wrapper { max-width: 400px; text-align: center; }
        #pix-qrcode-modal .pix-instructions-text { font-size: 0.9em; color: var(--text-muted); margin-bottom: 15px; }
        #qrcode-canvas-container {
            margin: 15px auto; border: 2px solid var(--boss-yellow);
            border-radius: var(--border-radius); background-color: white;
            padding: 10px; display: inline-block;
            min-width: 200px; min-height: 200px;
            display: flex; align-items: center; justify-content: center;
        }
        #qrcode-canvas-container img { max-width: 100%; height: auto; display: block; margin: 0 auto; }
        #pix-copia-cola-area { width: 100%; padding: 10px; margin-top: 10px;
            border: 1px solid var(--boss-border-color); border-radius: var(--border-radius);
            font-size: 0.8em; word-break: break-all; background-color: var(--boss-background-main);
            text-align: left; resize: none; font-family: monospace;
        }
        #copy-pix-code-btn {
            background-color: var(--boss-yellow); color: var(--boss-text-on-yellow);
            padding: 10px 15px; margin-top: 10px; border: none;
            border-radius: var(--border-radius); cursor: pointer; font-size: 0.9em;
            font-weight: 600; transition: background-color 0.2s ease;
        }
        #copy-pix-code-btn:hover { background-color: var(--boss-yellow-dark); }
        #copy-pix-code-btn i { margin-right: 6px; }
        #pix-payment-status-text { margin-top:12px; font-weight:600; font-size: 0.9em; }
        #pix-key-info-text { font-size:0.8em; margin-top:10px; color: var(--text-muted); }


        /* MODAL PAGAR DEPOIS */
        #pagar-depois-modal .modal-content-wrapper { max-width: 450px; }
        #pagar-depois-modal label { display:block; margin-bottom: 4px; font-size: 0.9em; font-weight: 500; }
        #pagar-depois-modal input[type="text"],
        #pagar-depois-modal input[type="tel"] {
            width: 100%; padding: 10px; font-size: 0.95em; margin-bottom: 12px;
            border: 1px solid var(--boss-border-color-strong); border-radius: var(--border-radius);
        }
        #pagar-depois-modal input:focus {
             border-color: var(--boss-yellow); outline: none; box-shadow: 0 0 0 2px var(--boss-yellow-light);
        }
        #pagar-depois-modal #confirmar-dados-pagar-depois-btn {
            background-color: var(--pending-color); color: var(--boss-text-on-yellow);
        }
        #pagar-depois-modal #confirmar-dados-pagar-depois-btn:hover {
            background-color: var(--boss-yellow-dark);
        }


        .feedback-message {
            margin: 20px auto; text-align:center; font-size: 0.9em;
            padding: 15px; color: var(--text-muted); width: fit-content;
        }
        #cart-items-list .feedback-message { margin: 0; width: 100%; }
        .feedback-message.error { color: var(--danger-color); background-color: #fdd; border-radius: var(--border-radius);}
        .feedback-message.loading i { margin-right: 8px; animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .btn-primary { /* Classe genérica para botões primários em modais */
             background-color: var(--boss-yellow); color: var(--boss-text-on-yellow); border:none;
             border-radius: var(--border-radius); cursor:pointer; font-weight: 600;
        }
        .btn-primary:hover { background-color: var(--boss-yellow-dark); }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="top-header">
            <h1><i class="fas fa-bolt"></i> Venda Rápida</h1>
            <div class="header-buttons-group">
                <button id="btn-montar-bolsa-main" class="header-action-btn"><i class="fas fa-shopping-bag"></i> Bolsa</button>
                <a href="pendentespagamentos.html" id="btn-pagamentos-pendentes" class="header-action-btn"><i class="fas fa-hourglass-half"></i> Pendentes</a>
            </div>
        </header>

        <div class="venda-content-area">
            <div id="product-grid">
                <p class="feedback-message loading" id="loading-indicator-grid"><i class="fas fa-spinner"></i>Carregando...</p>
            </div>

            <div id="cart-and-checkout-area">
                <ul id="cart-items-list"></ul>
                <div id="cart-summary">
                    <div id="cart-total-display">Total: R$ 0,00</div>
                </div>

                <div id="payment-options-selector">
                    <h3>Pagamento:</h3>
                    <div class="payment-methods-container">
                        <button class="payment-method-btn pix" data-method="PIX"><i class="fas fa-qrcode"></i>PIX</button>
                        <button class="payment-method-btn card" data-method="Débito"><i class="fas fa-credit-card"></i>Débito</button>
                        <button class="payment-method-btn card" data-method="Crédito"><i class="far fa-credit-card"></i>Crédito</button>
                        <button class="payment-method-btn" data-method="Dinheiro"><i class="fas fa-money-bill-wave"></i>Dinheiro</button>
                        <button class="payment-method-btn pagar-depois" data-method="Pagar Depois"><i class="fas fa-user-clock"></i>Pagar Depois</button>
                    </div>
                </div>

                <div id="cash-payment-details" style="display: none;">
                    <label for="amount-paid">Valor Pago (R$):</label>
                    <input type="number" id="amount-paid" placeholder="0.00" step="0.01" min="0">
                    <div id="change-due-display">Troco: R$ 0,00</div>
                </div>

                <div id="finalize-sale-btn-container">
                    <button id="finalize-sale-btn" disabled><i class="fas fa-check-circle"></i> Finalizar Venda</button>
                </div>
            </div>
        </div>
    </div>

    <div id="montar-bolsa-modal" class="modal">
        <div class="modal-content-wrapper">
            <div class="modal-header-area">
                <h2><i class="fas fa-shopping-bag"></i> Montar Bolsa de Venda</h2>
                <button id="close-montar-bolsa-modal-btn" class="modal-close-button">&times;</button>
            </div>
            <div class="modal-body-content">
                <p class="modal-description-text" style="margin-bottom:15px; font-size:0.9em; color:var(--text-muted);">Selecione os produtos e quantidades que levará para vender (máx: estoque atual).</p>
                <div id="lista-catalogo-para-bolsa">
                    <p class="feedback-message loading"><i class="fas fa-spinner"></i>Carregando catálogo...</p>
                </div>
            </div>
            <div class="modal-footer-area">
                <button id="confirmar-bolsa-btn" class="btn-primary"><i class="fas fa-check"></i> Confirmar Bolsa</button>
            </div>
        </div>
    </div>

    <div id="pix-qrcode-modal" class="modal">
        <div class="modal-content-wrapper">
            <div class="modal-header-area">
                <h2><i class="fas fa-qrcode"></i> Pagamento via PIX</h2>
                <button id="close-pix-modal-btn" class="modal-close-button">&times;</button>
            </div>
            <div class="modal-body-content" style="text-align: center;">
                <p class="pix-instructions-text">Escaneie o QR Code ou use o "Copia e Cola":</p>
                <div id="qrcode-canvas-container"></div>
                <textarea id="pix-copia-cola-area" rows="3" readonly title="PIX Copia e Cola"></textarea>
                <button id="copy-pix-code-btn" class="btn-primary" style="padding:10px 15px; margin-top:10px; font-size:0.9em;"><i class="fas fa-copy"></i> Copiar Código</button>
                <p id="pix-key-info-text">Chave PIX: [Sua Chave]</p>
                <p id="pix-payment-status-text"></p>
            </div>
            <div class="modal-footer-area">
                <button id="btn-close-pix-and-clear" class="btn-primary" style="background-color: var(--text-muted);"><i class="fas fa-check-double"></i> Venda Concluída (Fechar)</button>
            </div>
        </div>
    </div>

    <div id="pagar-depois-modal" class="modal">
        <div class="modal-content-wrapper">
            <div class="modal-header-area">
                <h2><i class="fas fa-user-plus"></i> Cliente (Pagar Depois)</h2>
                <button id="close-pagar-depois-modal-btn" class="modal-close-button">&times;</button>
            </div>
            <div class="modal-body-content">
                <label for="pagar-depois-cliente-nome">Nome do Cliente:</label>
                <input type="text" id="pagar-depois-cliente-nome" list="clientes-cadastrados-list" placeholder="Nome completo (obrigatório)">
                <datalist id="clientes-cadastrados-list">
                    </datalist>

                <label for="pagar-depois-cliente-telefone">Telefone (WhatsApp com DDD):</label>
                <input type="tel" id="pagar-depois-cliente-telefone" placeholder="Ex: 11999998888">
            </div>
            <div class="modal-footer-area">
                <button id="confirmar-dados-pagar-depois-btn" class="btn-primary"><i class="fas fa-user-check"></i> Confirmar Cliente e Finalizar</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, Timestamp, runTransaction, orderBy, query, addDoc, where, updateDoc, limit, setDoc } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD5DNTmLpQZWihjDDGHkFa5S5zuEJHquno", // SUA API KEY AQUI
            authDomain: "bossexpress-6f223.firebaseapp.com",
            projectId: "bossexpress-6f223",
            storageBucket: "bossexpress-6f223.firebasestorage.app",
            messagingSenderId: "127302407767",
            appId: "1:127302407767:web:c50d1adc02f6837c79f512",
            measurementId: "G-W255R6N65R"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const clientesFiadoCollectionRef = collection(db, "clientesFiado"); // Referência para a coleção de clientes

        // Elementos da UI (mantidos)
        const productGridEl = document.getElementById("product-grid");
        const loadingIndicatorGridEl = document.getElementById("loading-indicator-grid");
        const cartItemsListEl = document.getElementById("cart-items-list");
        const cartTotalDisplayEl = document.getElementById("cart-total-display");
        const finalizeSaleBtnEl = document.getElementById("finalize-sale-btn");
        const paymentMethodButtonsEl = document.querySelectorAll(".payment-method-btn");
        const montarBolsaModalEl = document.getElementById("montar-bolsa-modal");
        const listaCatalogoParaBolsaDivEl = document.getElementById("lista-catalogo-para-bolsa");
        const confirmarBolsaBtnEl = document.getElementById("confirmar-bolsa-btn");
        const closeMontarBolsaModalBtnEl = document.getElementById("close-montar-bolsa-modal-btn");
        const btnMontarBolsaMainEl = document.getElementById("btn-montar-bolsa-main");
        const pixModalEl = document.getElementById("pix-qrcode-modal");
        const closePixModalBtnEl = document.getElementById("close-pix-modal-btn");
        const qrcodeCanvasContainerEl = document.getElementById("qrcode-canvas-container");
        const pixCopiaColaAreaEl = document.getElementById("pix-copia-cola-area");
        const copyPixCodeBtnEl = document.getElementById("copy-pix-code-btn");
        const pixPaymentStatusTextEl = document.getElementById("pix-payment-status-text");
        const pixKeyInfoTextEl = document.getElementById("pix-key-info-text");
        const btnClosePixAndClearEl = document.getElementById("btn-close-pix-and-clear");
        const cashPaymentDetailsEl = document.getElementById("cash-payment-details");
        const amountPaidInputEl = document.getElementById("amount-paid");
        const changeDueDisplayEl = document.getElementById("change-due-display");
        const pagarDepoisModalEl = document.getElementById("pagar-depois-modal");
        const closePagarDepoisModalBtnEl = document.getElementById("close-pagar-depois-modal-btn");
        const clienteNomeInputEl = document.getElementById("pagar-depois-cliente-nome");
        const clienteTelefoneInputEl = document.getElementById("pagar-depois-cliente-telefone");
        const clientesDatalistEl = document.getElementById("clientes-cadastrados-list");
        const confirmarDadosPagarDepoisBtnEl = document.getElementById("confirmar-dados-pagar-depois-btn");

        // Estado da Aplicação
        let catalogoCompletoProdutos = [];
        let bolsaDoVendedor = [];
        let cart = [];
        let selectedPaymentMethod = null;
        let qrCodeInstance = null;
        const localStorageBolsaKey = "bossExpressVendaRapidaBolsa_v2";
        let clientesFiadoCache = []; // Cache local dos clientes do Firebase


        // --- Funções Utilitárias ---
        const showFeedback = (el, message, type = 'info') => {
            if (!el) return;
            const iconHtml = type === 'loading' ? '<i class="fas fa-spinner fa-spin"></i> ' : '';
            el.innerHTML = `<p class="feedback-message ${type}">${iconHtml}${message}</p>`;
            if (el !== listaCatalogoParaBolsaDivEl && el !== productGridEl) {
                 el.style.display = 'flex'; el.style.justifyContent = 'center'; el.style.alignItems = 'center';
            } else if (el === listaCatalogoParaBolsaDivEl || el === productGridEl) {
                el.style.display = 'flex'; el.style.justifyContent = 'center'; el.style.alignItems = 'center';
            }
        };
        const clearFeedback = (el) => {
            if (!el) return;
            el.innerHTML = '';
            if (el === listaCatalogoParaBolsaDivEl) {
                el.style.justifyContent = 'flex-start'; el.style.alignItems = 'stretch';
            } else if (el === productGridEl) { /* Não mexe no display do grid */ }
            else if (el !== loadingIndicatorGridEl) {
                el.style.display = 'none';
            }
        };
        function formatCurrency(value) { return `R$ ${Number(value).toFixed(2).replace('.', ',')}`; }


        // --- Gestão de Clientes (Firebase) ---
        async function carregarClientesFiadoDoFirebase() {
            console.log("Carregando clientes do Firebase...");
            try {
                const q = query(clientesFiadoCollectionRef, orderBy("nomeLower"));
                const querySnapshot = await getDocs(q);
                clientesFiadoCache = []; // Limpa cache local
                querySnapshot.forEach((doc) => {
                    clientesFiadoCache.push({ id: doc.id, ...doc.data() });
                });
                renderizarClientesDatalist();
                console.log("Clientes carregados do Firebase:", clientesFiadoCache.length);
            } catch (error) {
                console.error("Erro ao carregar clientes do Firebase:", error);
                // Não mostrar alerta, apenas logar, para não interromper o fluxo principal se for um problema de rede temporário
            }
        }

        async function salvarClienteFiadoNoFirebase(nome, telefone) {
            const nomeTrimmed = nome.trim();
            const nomeLower = nomeTrimmed.toLowerCase();
            const telefoneLimpo = telefone.replace(/\D/g, ''); // Salva só números

            if (!nomeTrimmed) throw new Error("Nome do cliente não pode ser vazio.");

            try {
                // Verifica se cliente já existe pelo nomeLower
                const q = query(clientesFiadoCollectionRef, where("nomeLower", "==", nomeLower), limit(1));
                const querySnapshot = await getDocs(q);

                let clienteDocId;
                let clienteData;

                if (!querySnapshot.empty) { // Cliente existe, atualiza
                    const clienteDoc = querySnapshot.docs[0];
                    clienteDocId = clienteDoc.id;
                    const updateData = {
                        telefone: telefoneLimpo,
                        ultimaAtualizacao: Timestamp.now()
                    };
                    // Apenas atualiza o nome se o case for diferente, mantendo o nomeLower
                    if (clienteDoc.data().nome !== nomeTrimmed) {
                        updateData.nome = nomeTrimmed;
                    }
                    await updateDoc(doc(db, "clientesFiado", clienteDocId), updateData);
                    console.log("Cliente atualizado no Firebase:", clienteDocId);
                    clienteData = { id: clienteDocId, nome: nomeTrimmed, nomeLower, telefone: telefoneLimpo, ...updateData};
                } else { // Cliente não existe, cria novo
                    const newClienteRef = doc(clientesFiadoCollectionRef); // Gera ID automaticamente
                    clienteDocId = newClienteRef.id;
                    const novoCliente = {
                        nome: nomeTrimmed,
                        nomeLower: nomeLower,
                        telefone: telefoneLimpo,
                        dataCadastro: Timestamp.now(),
                        ultimaAtualizacao: Timestamp.now()
                    };
                    await setDoc(newClienteRef, novoCliente); // Usar setDoc com ref gerado
                    console.log("Novo cliente salvo no Firebase:", clienteDocId);
                    clienteData = { id: clienteDocId, ...novoCliente };
                }
                // Atualiza cache local e datalist
                const indexCache = clientesFiadoCache.findIndex(c => c.nomeLower === nomeLower);
                if (indexCache > -1) {
                    clientesFiadoCache[indexCache] = clienteData;
                } else {
                    clientesFiadoCache.push(clienteData);
                    clientesFiadoCache.sort((a,b) => a.nomeLower.localeCompare(b.nomeLower)); // Mantém ordenado
                }
                renderizarClientesDatalist();
                return clienteData; // Retorna o objeto completo do cliente com ID
            } catch (error) {
                console.error("Erro ao salvar cliente no Firebase:", error);
                throw error; // Re-throw para ser tratado pelo chamador
            }
        }

        function renderizarClientesDatalist() {
            clientesDatalistEl.innerHTML = ''; // Limpa datalist
            clientesFiadoCache.forEach(cliente => {
                const option = document.createElement('option');
                option.value = cliente.nome; // O que aparece na sugestão e no input
                // Não precisa de data-telefone aqui, pois vamos buscar no cache ao selecionar
                clientesDatalistEl.appendChild(option);
            });
        }

        clienteNomeInputEl.addEventListener('input', () => {
            const nomeDigitado = clienteNomeInputEl.value;
            const nomeDigitadoLower = nomeDigitado.toLowerCase();
            const clienteEncontrado = clientesFiadoCache.find(c => c.nome.toLowerCase() === nomeDigitadoLower);

            if (clienteEncontrado) {
                clienteTelefoneInputEl.value = clienteEncontrado.telefone || "";
                // Para garantir que o input reflita o nome como está no banco (case)
                if(clienteNomeInputEl.value !== clienteEncontrado.nome){
                    // Poderia auto-corrigir o case, mas pode ser irritante.
                    // Se o usuário selecionou do datalist, o case já estará correto.
                }
            } else {
                clienteTelefoneInputEl.value = ""; // Limpa se não achar correspondência exata
            }
        });

        // --- Montar Bolsa (sem alterações significativas, mantido como antes) ---
        async function carregarCatalogoParaModalBolsa() {
            showFeedback(listaCatalogoParaBolsaDivEl, 'Carregando catálogo...', 'loading');
            try {
                const q = query(collection(db, "produtos"), orderBy("nome"));
                const querySnapshot = await getDocs(q);
                catalogoCompletoProdutos = [];
                querySnapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    if (data.nome && typeof data.precoVenda === 'number') {
                        catalogoCompletoProdutos.push({
                            id: docSnap.id, nome: data.nome, precoVenda: data.precoVenda,
                            estoqueAtualFS: parseInt(data.estoqueAtual) || 0, unidade: data.unidade || 'UN'
                        });
                    }
                });
                renderizarOpcoesModalBolsa();
            } catch (error) {
                console.error("Erro ao carregar catálogo para bolsa:", error);
                showFeedback(listaCatalogoParaBolsaDivEl, 'Erro ao carregar catálogo.', 'error');
            }
        }
        function renderizarOpcoesModalBolsa() {
            clearFeedback(listaCatalogoParaBolsaDivEl);
            if (catalogoCompletoProdutos.length === 0) {
                showFeedback(listaCatalogoParaBolsaDivEl, 'Nenhum produto encontrado.'); return;
            }
            const bolsaAtualMap = new Map(bolsaDoVendedor.map(item => [item.id, item.quantidadeNaBolsa]));
            catalogoCompletoProdutos.forEach(produto => {
                const itemDiv = document.createElement("div");
                itemDiv.className = "catalogo-bolsa-item";
                const quantidadeNaBolsaAtual = bolsaAtualMap.get(produto.id) || 0;
                itemDiv.innerHTML = `
                    <label for="bolsa-${produto.id}">
                        <span class="item-name">${produto.nome} (${formatCurrency(produto.precoVenda)})</span>
                        <span class="item-stock-info">Estoque Loja: ${produto.estoqueAtualFS} ${produto.unidade}</span>
                    </label>
                    <input type="number" id="bolsa-${produto.id}" data-id="${produto.id}" data-nome="${produto.nome}" data-preco="${produto.precoVenda}" data-unidade="${produto.unidade}" data-estoque-loja="${produto.estoqueAtualFS}" min="0" max="${produto.estoqueAtualFS}" value="${quantidadeNaBolsaAtual}" placeholder="Qtde">`;
                listaCatalogoParaBolsaDivEl.appendChild(itemDiv);
                itemDiv.querySelector('input[type="number"]').addEventListener('input', (e) => {
                    let val = parseInt(e.target.value); const max = parseInt(e.target.max);
                    if (isNaN(val)) val = 0; if (val > max) e.target.value = max; if (val < 0) e.target.value = 0;
                });
            });
        }
        confirmarBolsaBtnEl.addEventListener("click", () => {
            bolsaDoVendedor = [];
            listaCatalogoParaBolsaDivEl.querySelectorAll('input[type="number"]').forEach(input => {
                let quantidade = parseInt(input.value);
                if (isNaN(quantidade) || quantidade < 0) quantidade = 0;
                const estoqueLoja = parseInt(input.dataset.estoqueLoja);
                if (quantidade > estoqueLoja) quantidade = estoqueLoja;
                if (quantidade > 0) {
                    bolsaDoVendedor.push({
                        id: input.dataset.id, nome: input.dataset.nome, preco: parseFloat(input.dataset.preco),
                        unidade: input.dataset.unidade, quantidadeNaBolsa: quantidade
                    });
                }
            });
            localStorage.setItem(localStorageBolsaKey, JSON.stringify(bolsaDoVendedor));
            montarBolsaModalEl.style.display = "none";
            renderizarProdutosDaBolsaNaGrade();
            resetCartAndPayment();
        });
        function carregarBolsaDoLocalStorage() {
            const bolsaSalva = localStorage.getItem(localStorageBolsaKey);
            if (bolsaSalva) {
                try { bolsaDoVendedor = JSON.parse(bolsaSalva); return true; }
                catch (e) { console.error("Erro localStorage bolsa:", e); localStorage.removeItem(localStorageBolsaKey); return false; }
            } return false;
        }
        btnMontarBolsaMainEl.addEventListener("click", () => { carregarCatalogoParaModalBolsa(); montarBolsaModalEl.style.display = "flex"; });
        closeMontarBolsaModalBtnEl.addEventListener("click", () => montarBolsaModalEl.style.display = "none");

        // --- Grade de Produtos e Carrinho (sem alterações significativas) ---
        function renderizarProdutosDaBolsaNaGrade() {
            clearFeedback(productGridEl);
            if (loadingIndicatorGridEl) loadingIndicatorGridEl.style.display = 'none';
            if (!bolsaDoVendedor || bolsaDoVendedor.length === 0) {
                showFeedback(productGridEl, 'Sua bolsa está vazia. Clique em "Bolsa" para adicionar itens.'); return;
            }
            let itensRealmenteDisponiveisNaBolsa = false;
            bolsaDoVendedor.forEach(productInBag => {
                const card = document.createElement("div");
                card.className = "product-card"; card.dataset.productId = productInBag.id;
                if (productInBag.quantidadeNaBolsa <= 0) card.classList.add("out-of-stock-bolsa");
                else { itensRealmenteDisponiveisNaBolsa = true; card.addEventListener("click", () => adicionarProdutoAoCarrinho(productInBag.id)); }
                card.innerHTML = `
                    <div class="product-name">${productInBag.nome}</div>
                    <div class="product-price">${formatCurrency(productInBag.preco)}</div>
                    <div class="product-stock-bolsa">Na Bolsa: ${productInBag.quantidadeNaBolsa} ${productInBag.unidade}</div>`;
                productGridEl.appendChild(card);
            });
            if (!itensRealmenteDisponiveisNaBolsa && bolsaDoVendedor.length > 0) {
                showFeedback(productGridEl, 'Todos os itens da sua bolsa foram vendidos! Monte uma nova bolsa.');
            }
        }
        function adicionarProdutoAoCarrinho(productId) {
            const produtoNaBolsa = bolsaDoVendedor.find(p => p.id === productId);
            if (!produtoNaBolsa || produtoNaBolsa.quantidadeNaBolsa <= 0) { alert("Esgotado na bolsa!"); return; }
            const cartItem = cart.find(item => item.id === productId);
            if (cartItem) {
                if (cartItem.quantidadeNoCarrinho < produtoNaBolsa.quantidadeNaBolsa) cartItem.quantidadeNoCarrinho++;
                else { alert(`Limite de ${produtoNaBolsa.nome} na bolsa atingido no carrinho.`); return; }
            } else {
                cart.push({ id: produtoNaBolsa.id, nome: produtoNaBolsa.nome, preco: produtoNaBolsa.preco, unidade: produtoNaBolsa.unidade, quantidadeNoCarrinho: 1 });
            }
            atualizarDisplayDoCarrinho();
        }
        function atualizarDisplayDoCarrinho() {
            cartItemsListEl.innerHTML = ""; let total = 0;
            if (cart.length === 0) {
                cartItemsListEl.innerHTML = `<li class="feedback-message" id="cart-empty-message">Carrinho vazio</li>`;
            } else {
                cart.forEach(item => {
                    const produtoNaBolsa = bolsaDoVendedor.find(p => p.id === item.id);
                    const maxQuantityInBag = produtoNaBolsa ? produtoNaBolsa.quantidadeNaBolsa : 0;
                    const li = document.createElement("li");
                    li.innerHTML = `
                        <div class="cart-item-details">
                            <span class="cart-item-name">${item.nome}</span>
                            <span class="cart-item-price">(${item.quantidadeNoCarrinho}x ${formatCurrency(item.preco)})</span>
                        </div>
                        <div class="cart-item-controls">
                            <button class="decrease-qty-btn" data-id="${item.id}" title="Diminuir"><i class="fas fa-minus"></i></button>
                            <span class="cart-item-quantity">${item.quantidadeNoCarrinho}</span>
                            <button class="increase-qty-btn" data-id="${item.id}" title="Aumentar" ${item.quantidadeNoCarrinho >= maxQuantityInBag ? 'disabled' : ''}><i class="fas fa-plus"></i></button>
                            <button class="remove-item-btn" data-id="${item.id}" title="Remover"><i class="fas fa-times"></i></button>
                        </div>`;
                    cartItemsListEl.appendChild(li);
                    total += item.preco * item.quantidadeNoCarrinho;
                });
            }
            cartTotalDisplayEl.textContent = `Total: ${formatCurrency(total)}`;
            atualizarEstadoBotaoFinalizar();
            if (selectedPaymentMethod === "Dinheiro") calcularTroco();
        }
        cartItemsListEl.addEventListener('click', (event) => {
            const target = event.target.closest('button'); if (!target) return;
            const itemId = target.dataset.id; const itemNoCarrinho = cart.find(i => i.id === itemId); if (!itemNoCarrinho) return;
            const produtoNaBolsa = bolsaDoVendedor.find(p => p.id === itemId); const maxQuantityInBag = produtoNaBolsa ? produtoNaBolsa.quantidadeNaBolsa : 0;
            if (target.classList.contains('increase-qty-btn')) { if (itemNoCarrinho.quantidadeNoCarrinho < maxQuantityInBag) itemNoCarrinho.quantidadeNoCarrinho++; }
            else if (target.classList.contains('decrease-qty-btn')) { itemNoCarrinho.quantidadeNoCarrinho--; if (itemNoCarrinho.quantidadeNoCarrinho <= 0) cart = cart.filter(i => i.id !== itemId); }
            else if (target.classList.contains('remove-item-btn')) cart = cart.filter(i => i.id !== itemId);
            atualizarDisplayDoCarrinho();
        });

        // --- Lógica de Pagamento (atualizada) ---
        paymentMethodButtonsEl.forEach(button => {
            button.addEventListener('click', () => {
                selectedPaymentMethod = button.dataset.method;
                paymentMethodButtonsEl.forEach(btn => btn.classList.remove('selected'));
                button.classList.add('selected');
                if (selectedPaymentMethod === "Dinheiro") {
                    cashPaymentDetailsEl.style.display = "block"; amountPaidInputEl.focus(); calcularTroco();
                } else {
                    cashPaymentDetailsEl.style.display = "none";
                }
                atualizarEstadoBotaoFinalizar();
            });
        });
        amountPaidInputEl.addEventListener('input', calcularTroco);
        function calcularTroco() { /* ... mantida como antes ... */
            if (selectedPaymentMethod !== "Dinheiro") return;
            const totalVenda = cart.reduce((sum, item) => sum + (item.preco * item.quantidadeNoCarrinho), 0);
            const valorPago = parseFloat(amountPaidInputEl.value) || 0;
            const troco = valorPago - totalVenda;
            changeDueDisplayEl.classList.remove('negative');
            if (valorPago > 0 && troco < 0) {
                changeDueDisplayEl.textContent = `Faltam: ${formatCurrency(Math.abs(troco))}`;
                changeDueDisplayEl.classList.add('negative');
            } else if (valorPago > 0 && valorPago >= totalVenda) {
                 changeDueDisplayEl.textContent = `Troco: ${formatCurrency(troco)}`;
            } else if (valorPago === 0 && totalVenda > 0) { // Se valor pago é 0, mas há total
                 changeDueDisplayEl.textContent = `Troco: ${formatCurrency(0)}`; // Mostra troco 0, mas botão finalizar pode estar desabilitado
            } else { // Se valor pago é 0 e total é 0
                 changeDueDisplayEl.textContent = `Troco: R$ 0,00`;
            }
            atualizarEstadoBotaoFinalizar();
        }
        function atualizarEstadoBotaoFinalizar() { /* ... mantida como antes ... */
            const totalVenda = cart.reduce((sum, item) => sum + (item.preco * item.quantidadeNoCarrinho), 0);
            let podeFinalizar = cart.length > 0 && !!selectedPaymentMethod;
            if (selectedPaymentMethod === "Dinheiro") {
                const valorPago = parseFloat(amountPaidInputEl.value) || 0;
                if (valorPago < totalVenda) { podeFinalizar = false; }
            }
            finalizeSaleBtnEl.disabled = !podeFinalizar;
        }
        function resetCartAndPayment(limparCliente = true) { /* ... mantida como antes ... */
            cart = []; selectedPaymentMethod = null;
            paymentMethodButtonsEl.forEach(btn => btn.classList.remove('selected'));
            cashPaymentDetailsEl.style.display = "none"; amountPaidInputEl.value = "";
            changeDueDisplayEl.textContent = "Troco: R$ 0,00"; changeDueDisplayEl.classList.remove('negative');
            if (limparCliente) { clienteNomeInputEl.value = ""; clienteTelefoneInputEl.value = ""; }
            atualizarDisplayDoCarrinho();
        }


        // --- Finalizar Venda (atualizada para Pagar Depois com Firebase) ---
        finalizeSaleBtnEl.addEventListener("click", async () => {
            if (finalizeSaleBtnEl.disabled) return;
            const totalVenda = cart.reduce((sum, item) => sum + (item.preco * item.quantidadeNoCarrinho), 0);
            finalizeSaleBtnEl.disabled = true;
            finalizeSaleBtnEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';

            if (selectedPaymentMethod === "Pagar Depois") {
                pagarDepoisModalEl.style.display = "flex";
                clienteNomeInputEl.focus();
                // O processamento continua no handler do botão "confirmar-dados-pagar-depois-btn"
                // Reabilitar o botão de finalizar da tela principal se o modal for fechado
                finalizeSaleBtnEl.disabled = cart.length === 0 || !selectedPaymentMethod; // Reavalia baseado no estado atual
                finalizeSaleBtnEl.innerHTML = '<i class="fas fa-check-circle"></i> Finalizar Venda';
                return;
            }
            // ... resto da lógica para PIX, Dinheiro, etc. (mantida como antes) ...
            if (selectedPaymentMethod === "PIX") {
                const chavePix = "43152513801"; const nomeBeneficiario = "Boss Express"; const cidadeBeneficiario = "ITU";
                pixKeyInfoTextEl.textContent = `Chave PIX (CPF): ${chavePix}`;
                const identificadorTransacao = "BE" + Date.now().toString().slice(-8);
                const pixPayload = generatePixPayload(chavePix, nomeBeneficiario, cidadeBeneficiario, totalVenda, identificadorTransacao);
                if(qrCodeInstance) { qrCodeInstance.clear(); qrcodeCanvasContainerEl.innerHTML = ''; }
                try {
                    qrCodeInstance = new QRCode(qrcodeCanvasContainerEl, { text: pixPayload, width: 200, height: 200, colorDark : "#000000", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.M });
                } catch (e) { console.error("Erro QRCode:", e); qrcodeCanvasContainerEl.innerHTML = "<p class='feedback-message error'>Erro QR Code.</p>"; }
                pixCopiaColaAreaEl.value = pixPayload;
                pixPaymentStatusTextEl.textContent = `Total: ${formatCurrency(totalVenda)}. Aguardando...`;
                pixModalEl.style.display = "flex";
                await registrarVendaEAtualizarEstoque(totalVenda, selectedPaymentMethod, null, { payloadPix: pixPayload, idTxPix: identificadorTransacao, chavePixDestino: chavePix }, null);
            } else { // Dinheiro, Débito, Crédito
                let dadosPagamentoDinheiro = null;
                if (selectedPaymentMethod === "Dinheiro") {
                    const valorPago = parseFloat(amountPaidInputEl.value) || 0;
                    const troco = valorPago - totalVenda;
                    dadosPagamentoDinheiro = { valorPago: valorPago, troco: troco };
                }
                try {
                    await registrarVendaEAtualizarEstoque(totalVenda, selectedPaymentMethod, dadosPagamentoDinheiro, null, null);
                    alert(`Venda de ${formatCurrency(totalVenda)} com ${selectedPaymentMethod} finalizada! ${selectedPaymentMethod === "Dinheiro" ? `Troco: ${formatCurrency(dadosPagamentoDinheiro.troco)}` : ''}`);
                    resetCartAndPayment();
                    renderizarProdutosDaBolsaNaGrade();
                } catch (error) {
                    console.error("Erro ao finalizar venda:", error);
                    alert(`Erro ao finalizar venda: ${error.message || String(error)}`);
                }
            }
            if (selectedPaymentMethod !== "Pagar Depois") {
                 atualizarEstadoBotaoFinalizar();
                 finalizeSaleBtnEl.innerHTML = '<i class="fas fa-check-circle"></i> Finalizar Venda';
            }
        });

        confirmarDadosPagarDepoisBtnEl.addEventListener("click", async () => {
            const nomeClienteInput = clienteNomeInputEl.value.trim();
            const telefoneClienteInput = clienteTelefoneInputEl.value.trim(); // Validação/formatação do telefone pode ser mais robusta

            if (!nomeClienteInput) {
                alert("Por favor, insira o nome do cliente.");
                clienteNomeInputEl.focus();
                return;
            }

            confirmarDadosPagarDepoisBtnEl.disabled = true;
            confirmarDadosPagarDepoisBtnEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';

            try {
                const clienteSalvo = await salvarClienteFiadoNoFirebase(nomeClienteInput, telefoneClienteInput); // Salva/atualiza no Firebase
                const totalVenda = cart.reduce((sum, item) => sum + (item.preco * item.quantidadeNoCarrinho), 0);

                await registrarVendaEAtualizarEstoque(totalVenda, "Pagar Depois", null, null,
                    { docId: clienteSalvo.id, nome: clienteSalvo.nome, telefone: clienteSalvo.telefone }
                );
                alert(`Venda de ${formatCurrency(totalVenda)} registrada para ${clienteSalvo.nome} (Pagar Depois).`);
                pagarDepoisModalEl.style.display = "none";
                resetCartAndPayment();
                renderizarProdutosDaBolsaNaGrade();
            } catch (error) {
                console.error("Erro ao registrar venda 'Pagar Depois':", error);
                alert(`Erro ao registrar venda 'Pagar Depois': ${error.message || String(error)}`);
            } finally {
                confirmarDadosPagarDepoisBtnEl.disabled = false;
                confirmarDadosPagarDepoisBtnEl.innerHTML = '<i class="fas fa-user-check"></i> Confirmar Cliente e Finalizar';
                atualizarEstadoBotaoFinalizar(); // Atualiza o botão principal da tela de venda
                finalizeSaleBtnEl.innerHTML = '<i class="fas fa-check-circle"></i> Finalizar Venda';
            }
        });

        async function registrarVendaEAtualizarEstoque(valorTotalVenda, formaDePagamento, dadosDinheiro = null, dadosPix = null, dadosClienteFiado = null) {
            // ... (lógica interna da transação mantida como antes, mas agora recebe dadosClienteFiado.docId) ...
            const itensVendidosCopia = JSON.parse(JSON.stringify(cart));
            await runTransaction(db, async (transaction) => {
                const produtosParaAtualizarRefs = new Map();
                for (const itemVendido of itensVendidosCopia) {
                    if (!produtosParaAtualizarRefs.has(itemVendido.id)) {
                        produtosParaAtualizarRefs.set(itemVendido.id, doc(db, "produtos", itemVendido.id));
                    }
                }
                const produtosFirestoreDocs = await Promise.all(
                    Array.from(produtosParaAtualizarRefs.values()).map(ref => transaction.get(ref))
                );
                const produtosDataMap = new Map();
                produtosFirestoreDocs.forEach(docSnap => {
                    if (docSnap.exists()) {
                        produtosDataMap.set(docSnap.id, docSnap.data());
                    } else {
                        const itemProblematico = itensVendidosCopia.find(item => item.id === docSnap.id);
                        throw new Error(`Produto "${itemProblematico ? itemProblematico.nome : 'Desconhecido'}" (ID: ${docSnap.id}) não encontrado.`);
                    }
                });

                for (const itemVendido of itensVendidosCopia) {
                    const dadosProduto = produtosDataMap.get(itemVendido.id);
                    const estoqueAtualFS = dadosProduto.estoqueAtual || 0;
                    const novoEstoqueFS = estoqueAtualFS - itemVendido.quantidadeNoCarrinho;
                    if (novoEstoqueFS < 0) throw new Error(`Estoque de "${itemVendido.nome}" (${estoqueAtualFS}) insuficiente para vender ${itemVendido.quantidadeNoCarrinho}.`);
                    transaction.update(produtosParaAtualizarRefs.get(itemVendido.id), { estoqueAtual: novoEstoqueFS });
                }

                const vendaData = {
                    itens: itensVendidosCopia.map(item => ({
                        produtoId: item.id, nome: item.nome, precoUnitario: item.preco,
                        quantidade: item.quantidadeNoCarrinho, subtotal: item.preco * item.quantidadeNoCarrinho,
                        unidade: item.unidade
                    })),
                    valorTotal: valorTotalVenda,
                    dataVenda: Timestamp.now(),
                    formaPagamento: formaDePagamento,
                    statusPagamento: (formaDePagamento === "PIX") ? "pendente_confirmacao_cliente" : (formaDePagamento === "Pagar Depois" ? "pendente_cliente" : "concluido")
                };
                if (dadosDinheiro) {
                    vendaData.valorPagoDinheiro = dadosDinheiro.valorPago;
                    vendaData.trocoDinheiro = dadosDinheiro.troco;
                }
                if (dadosPix) {
                    vendaData.payloadPix = dadosPix.payloadPix; vendaData.idTxPix = dadosPix.idTxPix; vendaData.chavePixDestino = dadosPix.chavePixDestino;
                }
                if (dadosClienteFiado) {
                    vendaData.clienteDocId = dadosClienteFiado.docId; // ID do cliente do Firebase
                    vendaData.clienteNome = dadosClienteFiado.nome;
                    vendaData.clienteTelefone = dadosClienteFiado.telefone;
                }
                await addDoc(collection(db, "vendas_rapidas"), vendaData); // Usar addDoc
            });
            itensVendidosCopia.forEach(itemVendido => {
                const itemNaBolsa = bolsaDoVendedor.find(p => p.id === itemVendido.id);
                if (itemNaBolsa) {
                    itemNaBolsa.quantidadeNaBolsa -= itemVendido.quantidadeNoCarrinho;
                    if (itemNaBolsa.quantidadeNaBolsa < 0) itemNaBolsa.quantidadeNaBolsa = 0;
                }
            });
            localStorage.setItem(localStorageBolsaKey, JSON.stringify(bolsaDoVendedor));
        }


        // --- Funções PIX (mantidas como antes) ---
        function formatPixValue(value) { /* ... */ return value.toFixed(2).toString(); }
        function generatePixPayload(chavePix, nomeBeneficiario, cidadeBeneficiario, valor, identificadorTx = 'VENTABOSS') { /* ... */
            const payloadFormatIndicator = "000201"; const pointOfInitiationMethod = "010211";
            const gui = "br.gov.bcb.pix"; const chave = String(chavePix).replace(/\D/g, '');
            const merchantAccountInfo_TagChave = "01" + String(chave.length).padStart(2, '0') + chave;
            const merchantAccountInfo_Valor = "00" + String(gui.length).padStart(2, '0') + gui + merchantAccountInfo_TagChave;
            const merchantAccountInfo = "26" + String(merchantAccountInfo_Valor.length).padStart(2, '0') + merchantAccountInfo_Valor;
            const merchantCategoryCode = "0000"; const transactionCurrency = "986";
            const valorFormatado = formatPixValue(parseFloat(valor));
            const transactionAmount = "54" + String(valorFormatado.length).padStart(2, '0') + valorFormatado;
            const countryCode = "BR";
            const beneficiarioNomeNorm = String(nomeBeneficiario).normalize("NFD").replace(/[\u0300-\u036f]/g, "").substring(0, 25).toUpperCase();
            const merchantName = "59" + String(beneficiarioNomeNorm.length).padStart(2, '0') + beneficiarioNomeNorm;
            const beneficiarioCidadeNorm = String(cidadeBeneficiario).normalize("NFD").replace(/[\u0300-\u036f]/g, "").substring(0, 15).toUpperCase();
            const merchantCity = "60" + String(beneficiarioCidadeNorm.length).padStart(2, '0') + beneficiarioCidadeNorm;
            const txIdLimpo = String(identificadorTx).replace(/[^a-zA-Z0-9]/g, '').substring(0,25) || '***';
            const additionalDataField_TXIDVal = "05" + String(txIdLimpo.length).padStart(2, '0') + txIdLimpo;
            const additionalDataField = "62" + String(additionalDataField_TXIDVal.length).padStart(2, '0') + additionalDataField_TXIDVal;
            let payload = `${payloadFormatIndicator}${pointOfInitiationMethod}${merchantAccountInfo}52${String(merchantCategoryCode.length).padStart(2,'0')}${merchantCategoryCode}53${String(transactionCurrency.length).padStart(2,'0')}${transactionCurrency}${transactionAmount}58${String(countryCode.length).padStart(2,'0')}${countryCode}${merchantName}${merchantCity}${additionalDataField}6304`;
            payload += calculateCRC16(payload.substring(0, payload.length - 4));
            return payload;
         }
        function calculateCRC16(payload) { /* ... */
            let crc = 0xFFFF; const polinomio = 0x1021;
            for (let i = 0; i < payload.length; i++) {
                crc ^= (payload.charCodeAt(i) << 8);
                for (let j = 0; j < 8; j++) crc = (crc & 0x8000) ? (crc << 1) ^ polinomio : crc << 1;
            }
            return (crc & 0xFFFF).toString(16).toUpperCase().padStart(4, '0');
        }
        btnClosePixAndClearEl.addEventListener("click", () => { /* ... */
            pixModalEl.style.display = "none"; resetCartAndPayment(); renderizarProdutosDaBolsaNaGrade();
            pixPaymentStatusTextEl.textContent = ''; qrcodeCanvasContainerEl.innerHTML = '';
            if(qrCodeInstance) qrCodeInstance.clear();
        });
        copyPixCodeBtnEl.addEventListener("click", () => { /* ... */
            pixCopiaColaAreaEl.select();
            try { document.execCommand("copy"); alert("Código PIX Copiado!"); }
            catch(err) { alert("Falha ao copiar."); }
        });


        // --- Event Listeners Gerais para Modais (atualizado) ---
        function closeModalOnClickOutside(event) {
            if (event.target === montarBolsaModalEl) montarBolsaModalEl.style.display = "none";
            if (event.target === pixModalEl) pixModalEl.style.display = "none";
            if (event.target === pagarDepoisModalEl) {
                pagarDepoisModalEl.style.display = "none";
                 if (selectedPaymentMethod === "Pagar Depois" && finalizeSaleBtnEl.innerHTML.includes("Processando")) {
                    // Se o modal foi fechado enquanto o botão principal estava processando "Pagar Depois"
                    finalizeSaleBtnEl.disabled = cart.length === 0 || !selectedPaymentMethod; // Reavalia
                    finalizeSaleBtnEl.innerHTML = '<i class="fas fa-check-circle"></i> Finalizar Venda';
                 }
            }
        }
        window.addEventListener("click", closeModalOnClickOutside);
        window.addEventListener("keydown", (event) => {
            if (event.key === "Escape") {
                if (montarBolsaModalEl.style.display === "flex") montarBolsaModalEl.style.display = "none";
                if (pixModalEl.style.display === "flex") pixModalEl.style.display = "none";
                if (pagarDepoisModalEl.style.display === "flex") {
                    pagarDepoisModalEl.style.display = "none";
                    if (selectedPaymentMethod === "Pagar Depois" && finalizeSaleBtnEl.innerHTML.includes("Processando")) {
                        finalizeSaleBtnEl.disabled = cart.length === 0 || !selectedPaymentMethod;
                        finalizeSaleBtnEl.innerHTML = '<i class="fas fa-check-circle"></i> Finalizar Venda';
                    }
                }
            }
        });
        closePagarDepoisModalBtnEl.addEventListener("click", () => {
            pagarDepoisModalEl.style.display = "none";
            if (selectedPaymentMethod === "Pagar Depois" && finalizeSaleBtnEl.innerHTML.includes("Processando")) {
                 finalizeSaleBtnEl.disabled = cart.length === 0 || !selectedPaymentMethod;
                 finalizeSaleBtnEl.innerHTML = '<i class="fas fa-check-circle"></i> Finalizar Venda';
            }
        });


        // --- Inicialização ---
        document.addEventListener("DOMContentLoaded", async () => {
            const initialLoadingEl = loadingIndicatorGridEl || productGridEl;
            showFeedback(initialLoadingEl, 'Inicializando...', 'loading');
            if (!db) { showFeedback(initialLoadingEl, 'Erro de conexão com o banco de dados.', 'error'); return; }

            await carregarClientesFiadoDoFirebase(); // Carrega clientes do Firebase para o datalist

            if (!carregarBolsaDoLocalStorage() || bolsaDoVendedor.length === 0) {
                clearFeedback(initialLoadingEl);
                abrirModalMontarBolsa();
                showFeedback(productGridEl, 'Monte sua bolsa para começar a vender.');
            } else {
                renderizarProdutosDaBolsaNaGrade();
            }
            atualizarDisplayDoCarrinho();
            console.log("Boss Express - Venda Rápida Pronta.");
        });
    </script>
</body>
</html>